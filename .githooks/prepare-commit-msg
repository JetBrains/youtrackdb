#!/bin/bash
#
# Git hook to automatically add issue prefix to commit messages
# based on the branch name pattern: ytdb/YTDB + optional non-letter + numbers (case-insensitive)
# Examples: ytdb-509-feature -> "YTDB-509: <message>"
#           YTDB509-feature  -> "YTDB-509: <message>"

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Only process regular commits (not merges, amends with existing message, etc.)
# Allow: no source (regular commit), "message" (-m flag), "template"
if [ "$COMMIT_SOURCE" = "merge" ] || [ "$COMMIT_SOURCE" = "squash" ] || [ "$COMMIT_SOURCE" = "commit" ]; then
    exit 0
fi

# Get current branch name
BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null)

# Exit if not on a branch (detached HEAD)
if [ -z "$BRANCH_NAME" ]; then
    exit 0
fi

# Extract issue prefix: "ytdb" (case-insensitive) followed by optional non-letter followed by numbers
# Pattern explanation: ^(ytdb)([^a-zA-Z0-9]?)([0-9]+)
# - ^            : start of string
# - ytdb         : literal "ytdb" prefix (matched case-insensitively)
# - [^a-zA-Z0-9]?: optional single non-alphanumeric character (separator like - or _)
# - [0-9]+       : one or more digits
BRANCH_NAME_LOWER=$(echo "$BRANCH_NAME" | tr '[:upper:]' '[:lower:]')
if [[ $BRANCH_NAME_LOWER =~ ^(ytdb)([^a-zA-Z0-9]?)([0-9]+) ]]; then
    # Normalize the prefix: always use uppercase 'YTDB' and '-' as separator
    ISSUE_PREFIX="YTDB-${BASH_REMATCH[3]}"
    FULL_PREFIX="$ISSUE_PREFIX: "

    # Read current commit message
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

    # Check if the issue number already exists anywhere in the message (case-insensitive)
    ISSUE_PREFIX_LOWER=$(echo "$ISSUE_PREFIX" | tr '[:upper:]' '[:lower:]')
    COMMIT_MSG_LOWER=$(echo "$COMMIT_MSG" | tr '[:upper:]' '[:lower:]')

    if [[ ! "$COMMIT_MSG_LOWER" =~ $ISSUE_PREFIX_LOWER ]]; then
        # Prepend the issue prefix to the commit message
        echo -n "$FULL_PREFIX" > "$COMMIT_MSG_FILE"
        echo "$COMMIT_MSG" >> "$COMMIT_MSG_FILE"
    fi
fi

exit 0
