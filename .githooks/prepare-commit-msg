#!/bin/bash
#
# Git hook to automatically add issue prefix to commit messages
# based on the branch name or directory name pattern: ytdb/YTDB + optional non-letter + numbers (case-insensitive)
# Examples: ytdb-509-feature -> "YTDB-509: <message>"
#           YTDB509-feature  -> "YTDB-509: <message>"
#           directory: it-tests-fix with no branch match -> tries "ytdb-278-it-tests-fix" directory pattern
#
# Priority: branch name first, then directory name as fallback
#
# This hook only runs for JetBrains/youtrackdb repository.
# Can be installed globally: git config --global core.hooksPath <path-to-hooks-dir>

# Enable case-insensitive pattern matching
shopt -s nocasematch

# Check if this is the JetBrains/youtrackdb repository
REMOTE_URL=$(git remote get-url origin 2>/dev/null)
if [[ ! "$REMOTE_URL" =~ [/:]JetBrains/youtrackdb(\.git)?$ ]]; then
    exit 0
fi

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Only process regular commits (not merges, amends with existing message, etc.)
# Allow: no source (regular commit), "message" (-m flag), "template"
if [ "$COMMIT_SOURCE" = "merge" ] || [ "$COMMIT_SOURCE" = "squash" ] || [ "$COMMIT_SOURCE" = "commit" ]; then
    exit 0
fi

# Get current branch name
BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null)
ISSUE_PREFIX=""

# Try to extract issue prefix from branch name
if [ -n "$BRANCH_NAME" ]; then
    if [[ $BRANCH_NAME =~ ^(ytdb)([^a-zA-Z0-9]?)([0-9]+) ]]; then
        ISSUE_PREFIX="YTDB-${BASH_REMATCH[3]}"
    fi
fi

# If not found in branch name, try to extract from directory name
if [ -z "$ISSUE_PREFIX" ]; then
    DIR_NAME=$(basename "$(git rev-parse --show-toplevel 2>/dev/null)")
    if [[ $DIR_NAME =~ (ytdb)([^a-zA-Z0-9]?)([0-9]+) ]]; then
        ISSUE_PREFIX="YTDB-${BASH_REMATCH[3]}"
    fi
fi

# Check if we found an issue prefix
if [ -n "$ISSUE_PREFIX" ]; then
    FULL_PREFIX="$ISSUE_PREFIX: "

    # Read current commit message
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

    # Check if the issue number already exists anywhere in the message (case-insensitive due to nocasematch)
    if [[ ! "$COMMIT_MSG" =~ $ISSUE_PREFIX ]]; then
        # Prepend the issue prefix to the commit message
        echo -n "$FULL_PREFIX" > "$COMMIT_MSG_FILE"
        echo "$COMMIT_MSG" >> "$COMMIT_MSG_FILE"
    fi
fi

exit 0
