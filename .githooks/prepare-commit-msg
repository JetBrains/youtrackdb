#!/bin/bash
#
# Git hook to automatically add issue prefix to commit messages
# based on the branch name pattern: letters + non-letter + numbers
# Example: ytdb-509-feature-name -> "Issue ytdb-509: <message>"

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2

# Only process regular commits (not merges, amends with existing message, etc.)
# Allow: no source (regular commit), "message" (-m flag), "template"
if [ "$COMMIT_SOURCE" = "merge" ] || [ "$COMMIT_SOURCE" = "squash" ] || [ "$COMMIT_SOURCE" = "commit" ]; then
    exit 0
fi

# Get current branch name
BRANCH_NAME=$(git symbolic-ref --short HEAD 2>/dev/null)

# Exit if not on a branch (detached HEAD)
if [ -z "$BRANCH_NAME" ]; then
    exit 0
fi

# Extract issue prefix: letters followed by a single non-letter followed by numbers
# Pattern explanation: ^([a-zA-Z]+[^a-zA-Z0-9][0-9]+)
# - ^           : start of string
# - [a-zA-Z]+   : one or more letters
# - [^a-zA-Z0-9]: single non-alphanumeric character (separator like - or _)
# - [0-9]+      : one or more digits
if [[ $BRANCH_NAME =~ ^([a-zA-Z]+[^a-zA-Z0-9][0-9]+) ]]; then
    ISSUE_PREFIX="${BASH_REMATCH[1]}"
    FULL_PREFIX="Issue $ISSUE_PREFIX: "

    # Read current commit message
    COMMIT_MSG=$(cat "$COMMIT_MSG_FILE")

    # Check if the issue number already exists anywhere in the message (case-insensitive)
    ISSUE_PREFIX_LOWER=$(echo "$ISSUE_PREFIX" | tr '[:upper:]' '[:lower:]')
    COMMIT_MSG_LOWER=$(echo "$COMMIT_MSG" | tr '[:upper:]' '[:lower:]')

    if [[ ! "$COMMIT_MSG_LOWER" =~ $ISSUE_PREFIX_LOWER ]]; then
        # Prepend the issue prefix to the commit message
        echo -n "$FULL_PREFIX" > "$COMMIT_MSG_FILE"
        echo "$COMMIT_MSG" >> "$COMMIT_MSG_FILE"
    fi
fi

exit 0
