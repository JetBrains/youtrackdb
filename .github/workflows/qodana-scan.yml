name: Qodana
on:
  workflow_dispatch:
    inputs:
      cleanup:
        description: 'Apply Qodana cleanup fixes'
        required: false
        type: boolean
        default: false
  workflow_run:
    workflows: ["Java CI/CD Pipeline"]
    types: [completed]

concurrency:
  group: qodana-${{ github.event.workflow_run.head_sha || github.sha }}
  cancel-in-progress: true

env:
  QODANA_VERSION: "2025.3"

jobs:
  qodana:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      checks: write
      actions: read
    env:
      RUN_CLEANUP: ${{ github.event_name == 'workflow_dispatch' && inputs.cleanup == true }}
    steps:
      - uses: actions/checkout@v6
        with:
          ref: ${{ github.event.pull_request.head.sha || github.event.workflow_run.head_sha || github.ref }}
          fetch-depth: 0
          lfs: true

      - name: Download Coverage Data
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: coverage-data
          path: .qodana/code-coverage
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      - name: 'Qodana Scan'
        uses: JetBrains/qodana-action@v2025.3
        with:
          args: --linter, jetbrains/qodana-jvm:${{ env.QODANA_VERSION }}, --baseline, .github/workflows/qodana.sarif.json, -e, MAVEN_MIRROR_USERNAME=${{ secrets.MAVEN_MIRROR_USERNAME }}, -e, MAVEN_MIRROR_PASSWORD=${{ secrets.MAVEN_MIRROR_PASSWORD }}${{ env.RUN_CLEANUP == 'true' && ', --cleanup' || '' }}
          pr-mode: 'true'
          push-fixes: none
        env:
          QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}
          MAVEN_MIRROR_USERNAME: ${{ secrets.MAVEN_MIRROR_USERNAME }}
          MAVEN_MIRROR_PASSWORD: ${{ secrets.MAVEN_MIRROR_PASSWORD }}

      - name: Extract issue number from branch name
        if: env.RUN_CLEANUP == 'true'
        id: extract-issue
        shell: bash
        env:
          BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
        run: |
          set -euo pipefail

          BRANCH_NAME_LOWER="${BRANCH_NAME,,}"

          # Pattern: ytdb + optional non-alphanumeric + digits (case-insensitive)
          if [[ $BRANCH_NAME_LOWER =~ ^(ytdb)([^a-zA-Z0-9]?)([0-9]+) ]]; then
            ISSUE_PREFIX="YTDB-${BASH_REMATCH[3]}"
            echo "issue_prefix=${ISSUE_PREFIX}" >> "$GITHUB_OUTPUT"
            echo "has_issue=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_issue=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Push cleanup fixes branch
        if: env.RUN_CLEANUP == 'true'
        id: push-fixes
        shell: bash
        env:
          SOURCE_BRANCH: ${{ github.head_ref || github.ref_name }}
          HAS_ISSUE: ${{ steps.extract-issue.outputs.has_issue }}
          ISSUE_PREFIX: ${{ steps.extract-issue.outputs.issue_prefix }}
        run: |
          set -uo pipefail

          # Check if there are changes to commit
          if git diff --quiet && git diff --staged --quiet; then
            echo "No changes to commit"
            echo "has_fixes=false" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          set -e

          git config user.name "qodana-bot[bot]"
          git config user.email "qodana-bot[bot]@users.noreply.github.com"

          # Generate unique suffix using short SHA and run number
          UNIQUE_SUFFIX="${GITHUB_SHA:0:7}-${GITHUB_RUN_NUMBER}"

          # Build branch name with issue prefix if available
          if [[ "$HAS_ISSUE" == "true" ]]; then
            CLEANUP_BRANCH="${ISSUE_PREFIX}-qodana-fixes-${UNIQUE_SUFFIX}"
            COMMIT_MSG="${ISSUE_PREFIX}: Apply Qodana cleanup fixes"
          else
            # Sanitize branch name to avoid special character issues
            SANITIZED_SOURCE=$(echo "$SOURCE_BRANCH" | tr -cd '[:alnum:]-_/')
            CLEANUP_BRANCH="qodana-fixes-${SANITIZED_SOURCE}-${UNIQUE_SUFFIX}"
            COMMIT_MSG="Apply Qodana cleanup fixes"
          fi

          git checkout -b "$CLEANUP_BRANCH"
          git add -A
          git commit -m "$COMMIT_MSG"
          git push -u origin "$CLEANUP_BRANCH" --force-with-lease

          echo "cleanup_branch=$CLEANUP_BRANCH" >> "$GITHUB_OUTPUT"
          echo "source_branch=$SOURCE_BRANCH" >> "$GITHUB_OUTPUT"
          echo "has_fixes=true" >> "$GITHUB_OUTPUT"

      - name: Output fixes info
        if: env.RUN_CLEANUP == 'true' && steps.push-fixes.outputs.has_fixes == 'true'
        shell: bash
        env:
          CLEANUP_BRANCH: ${{ steps.push-fixes.outputs.cleanup_branch }}
          SOURCE_BRANCH: ${{ steps.push-fixes.outputs.source_branch }}
        run: |
          set -euo pipefail

          COMPARE_URL="https://github.com/${GITHUB_REPOSITORY}/compare/${SOURCE_BRANCH}...${CLEANUP_BRANCH}"
          PR_CREATE_URL="https://github.com/${GITHUB_REPOSITORY}/compare/${SOURCE_BRANCH}...${CLEANUP_BRANCH}?expand=1"

          # Output to job summary
          {
            echo "## ðŸ¤– Qodana Cleanup Fixes Available"
            echo ""
            echo "**Branch with fixes:** [\`$CLEANUP_BRANCH\`]($COMPARE_URL)"
            echo ""
            echo "**Options:**"
            echo "1. [Create a PR]($PR_CREATE_URL) to merge fixes into \`$SOURCE_BRANCH\`"
            echo "2. Cherry-pick commits: \`git cherry-pick origin/$CLEANUP_BRANCH\`"
            echo "3. Rebase locally: \`git rebase origin/$CLEANUP_BRANCH\`"
            echo ""
            echo "âš ï¸ Please review the changes before merging - automated fixes may not always be correct."
          } >> "$GITHUB_STEP_SUMMARY"
