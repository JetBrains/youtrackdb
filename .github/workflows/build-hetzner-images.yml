name: Build Hetzner Runner Images

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 1 * *' # Runs at 02:00 on the 1st of every month

jobs:
  build-and-cleanup:
    # Skip job on push events (push trigger is only for workflow registration)
    if: github.event_name != 'push'
    runs-on: ubuntu-latest
    env:
      HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: "latest"

      - name: Initialize Packer
        run: packer init .github/workflows/runner.pkr.hcl

      - name: Build Images
        run: packer build .github/workflows/runner.pkr.hcl

      # Install hcloud CLI for the cleanup step
      - name: Install hcloud CLI
        run: |
          curl -fsSL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar -xz
          sudo mv hcloud /usr/local/bin/hcloud

      - name: Get Latest Snapshot Names
        id: snapshots
        run: |
          # Get the most recently created snapshot for each architecture
          X86_IMAGE=$(hcloud image list --selector "role=github-runner,arch=x86" --sort created:desc -o json | jq -r '.[0].name')
          ARM_IMAGE=$(hcloud image list --selector "role=github-runner,arch=arm" --sort created:desc -o json | jq -r '.[0].name')

          echo "x86_image=$X86_IMAGE" >> $GITHUB_OUTPUT
          echo "arm_image=$ARM_IMAGE" >> $GITHUB_OUTPUT
          echo "Found latest images: x86=$X86_IMAGE, arm=$ARM_IMAGE"

      - name: Update Orchestrator Configuration
        env:
          ORCHESTRATOR_SSH_KEY: ${{ secrets.ORCHESTRATOR_SSH_KEY }}
          ORCHESTRATOR_HOST: ${{ secrets.ORCHESTRATOR_HOST }}
          X86_IMAGE: ${{ steps.snapshots.outputs.x86_image }}
          ARM_IMAGE: ${{ steps.snapshots.outputs.arm_image }}
        run: |
          # Skip if orchestrator is not configured
          if [ -z "$ORCHESTRATOR_HOST" ] || [ -z "$ORCHESTRATOR_SSH_KEY" ]; then
            echo "Orchestrator not configured (ORCHESTRATOR_HOST or ORCHESTRATOR_SSH_KEY missing). Skipping update."
            exit 0
          fi

          # Setup SSH
          mkdir -p ~/.ssh
          echo "$ORCHESTRATOR_SSH_KEY" > ~/.ssh/orchestrator_key
          chmod 600 ~/.ssh/orchestrator_key
          ssh-keyscan -H "$ORCHESTRATOR_HOST" >> ~/.ssh/known_hosts 2>/dev/null

          # Update the image names in the orchestrator's env file
          ssh -i ~/.ssh/orchestrator_key -o StrictHostKeyChecking=accept-new root@"$ORCHESTRATOR_HOST" << EOF
            set -e

            # Update image names in env file
            sed -i "s/^IMAGE_X64=.*/IMAGE_X64=$X86_IMAGE/" /etc/github-hetzner-runners/env
            sed -i "s/^IMAGE_ARM64=.*/IMAGE_ARM64=$ARM_IMAGE/" /etc/github-hetzner-runners/env

            # If variables don't exist, add them
            grep -q "^IMAGE_X64=" /etc/github-hetzner-runners/env || echo "IMAGE_X64=$X86_IMAGE" >> /etc/github-hetzner-runners/env
            grep -q "^IMAGE_ARM64=" /etc/github-hetzner-runners/env || echo "IMAGE_ARM64=$ARM_IMAGE" >> /etc/github-hetzner-runners/env

            echo "Updated env file:"
            grep "IMAGE_" /etc/github-hetzner-runners/env

            # Restart the service
            systemctl restart github-hetzner-runners

            # Wait and verify service is running
            sleep 5
            systemctl is-active github-hetzner-runners
            echo "Orchestrator updated and restarted successfully"
          EOF

          # Cleanup
          rm -f ~/.ssh/orchestrator_key

      - name: Cleanup Old Snapshots (Keep Last 2)
        shell: bash
        run: |
          # Function to clean up images by architecture
          cleanup_arch() {
            local ARCH=$1
            echo "Processing cleanup for $ARCH..."

            # List images with specific labels, sorted by creation (newest first)
            # We skip the first 2 (keep them) and get the IDs of the rest
            IMAGES_TO_DELETE=$(hcloud image list \
              --selector "role=github-runner,arch=$ARCH" \
              --sort created:desc \
              -o json | jq -r '.[2:] | .[].id')

            if [ -z "$IMAGES_TO_DELETE" ]; then
              echo "No old images to delete for $ARCH."
            else
              echo "Deleting old images for $ARCH: $IMAGES_TO_DELETE"
              for ID in $IMAGES_TO_DELETE; do
                hcloud image delete "$ID" || echo "Failed to delete $ID"
              done
            fi
          }

          # Run cleanup for both architectures
          cleanup_arch "x86"
          cleanup_arch "arm"
