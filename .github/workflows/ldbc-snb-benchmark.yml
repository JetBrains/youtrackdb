name: LDBC SNB Benchmark

permissions:
  contents: read
  pull-requests: write

on:
  # Manual: any branch, any SF
  workflow_dispatch:
    inputs:
      driver_sha:
        description: 'LDBC driver commit SHA'
        required: true
        default: '09c055620acd4d8c5623eedd41cf0c6b5934f4db'
      loader_sha:
        description: 'LDBC loader commit SHA. Uses driver_sha if empty.'
        required: false
        default: ''
      scale_factor:
        description: 'LDBC scale factor'
        required: false
        default: '0.1'
        type: choice
        options:
          - '0.1'
          - '0.3'
          - '1'
          - '3'
          - '10'

  # PR validation: label-triggered
  pull_request:
    types: [labeled, synchronize]
    branches: [develop]

concurrency:
  group: ldbc-snb-benchmark
  cancel-in-progress: false

jobs:
  benchmark:
    runs-on: [self-hosted, Linux, X64, benchmark]
    timeout-minutes: 360
    if: >-
      (github.event_name == 'workflow_dispatch') ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') ||
      (github.event_name == 'pull_request' &&
       contains(github.event.pull_request.labels.*.name, 'benchmark') &&
       github.event.pull_request.head.repo.full_name == github.repository)

    steps:
      - name: Determine parameters
        id: params
        run: |
          driver_sha="${{ inputs.driver_sha || '09c055620acd4d8c5623eedd41cf0c6b5934f4db' }}"
          loader_sha="${{ inputs.loader_sha }}"
          if [[ -z "${loader_sha}" ]]; then
            loader_sha="${driver_sha}"
          fi
          echo "driver_sha=${driver_sha}" >> $GITHUB_OUTPUT
          echo "loader_sha=${loader_sha}" >> $GITHUB_OUTPUT

          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "ref=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
            echo "sha=${{ github.event.workflow_run.head_sha }}" >> $GITHUB_OUTPUT
            echo "scale_factor=0.1" >> $GITHUB_OUTPUT
            echo "trigger=nightly" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" ]]; then
            echo "ref=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
            echo "sha=${{ github.event.pull_request.head.sha }}" >> $GITHUB_OUTPUT
            echo "scale_factor=0.1" >> $GITHUB_OUTPUT
            echo "trigger=pr" >> $GITHUB_OUTPUT
          else
            echo "ref=${{ github.ref }}" >> $GITHUB_OUTPUT
            echo "sha=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "scale_factor=${{ inputs.scale_factor || '0.1' }}" >> $GITHUB_OUTPUT
            echo "trigger=manual" >> $GITHUB_OUTPUT
          fi

      - name: Checkout YouTrackDB
        uses: actions/checkout@v6
        with:
          ref: ${{ steps.params.outputs.ref }}

      - name: Checkout LDBC Driver
        uses: actions/checkout@v6
        with:
          repository: JetBrains/ldbc-snb-interactive-gremlin
          ref: ${{ steps.params.outputs.driver_sha }}
          path: ldbc-driver

      - name: Checkout LDBC Loader
        uses: actions/checkout@v6
        with:
          repository: JetBrains/ldbc-snb-interactive-gremlin
          ref: ${{ steps.params.outputs.loader_sha }}
          path: ldbc-loader

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: perf/requirements.txt

      - name: Install dependencies
        working-directory: perf
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run benchmark
        id: benchmark
        working-directory: perf
        env:
          YTDB_REPO_PATH: ${{ github.workspace }}
          DRIVER_REPO_PATH: ${{ github.workspace }}/ldbc-driver
          LOADER_REPO_PATH: ${{ github.workspace }}/ldbc-loader/ytdb-loader
          YTDB_SHA: ${{ steps.params.outputs.sha }}
          DRIVER_SHA: ${{ steps.params.outputs.driver_sha }}
          LOADER_SHA: ${{ steps.params.outputs.loader_sha }}
          BENCH_DB_HOST: ${{ secrets.BENCH_DB_HOST }}
          BENCH_DB_IP: ${{ secrets.BENCH_DB_IP }}
          LDBC_SCALE_FACTOR: ${{ steps.params.outputs.scale_factor }}
        run: |
          python orchestrator.py config.yml

      - name: Generate report
        working-directory: perf
        run: |
          set -euo pipefail
          python report.py "${{ steps.benchmark.outputs.results_dir }}/driver_output/LDBC-SNB-results.json" \
            | tee "${{ steps.benchmark.outputs.results_dir }}/step_summary.md"

      - name: Upload results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results-${{ steps.params.outputs.trigger }}-sf${{ steps.params.outputs.scale_factor }}-${{ github.run_id }}
          path: perf/${{ steps.benchmark.outputs.results_dir }}
          retention-days: 90

      - name: Comment on PR
        if: github.event_name == 'pull_request' && success()
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ldbc-snb-benchmark
          path: perf/${{ steps.benchmark.outputs.results_dir }}/step_summary.md
