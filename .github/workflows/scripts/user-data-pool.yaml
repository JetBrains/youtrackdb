#cloud-config
package_update: true

# Create a non-root user for the runner (GitHub runners cannot run as root)
users:
  - name: runner-user
    groups: docker
    shell: /bin/bash
    sudo: ALL=(ALL) NOPASSWD:ALL

write_files:
  - path: /opt/runner-config.env
    permissions: '0600'
    content: |
      GITHUB_URL="https://github.com/${GITHUB_REPOSITORY}"
      GITHUB_PAT="${GITHUB_PAT}"
      REPO="${GITHUB_REPOSITORY}"
      BASE_NAME="${RUNNER_NAME}"
      NUM_RUNNERS=2

  - path: /opt/runner-launcher.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      # Load configuration
      source /opt/runner-config.env

      RUNNER_NUM=$1
      RUNNER_NAME="${BASE_NAME}-${RUNNER_NUM}"
      RUNNER_DIR="/home/runner-user/actions-runner-${RUNNER_NUM}"
      DRAIN_FILE="/var/run/drain-runner"

      # Detect architecture
      MACHINE_ARCH=$(uname -m)
      if [ "$MACHINE_ARCH" = "aarch64" ] || [ "$MACHINE_ARCH" = "arm64" ]; then
        RUNNER_ARCH="arm64"
      else
        RUNNER_ARCH="x64"
      fi

      cd "$RUNNER_DIR"

      echo "[$(date)] Starting launcher for $RUNNER_NAME"

      while true; do
        # Check for drain signal before starting new runner
        if [ -f "$DRAIN_FILE" ]; then
          echo "[$(date)] Drain signal detected, exiting launcher"
          exit 0
        fi

        # Get fresh registration token
        REG_TOKEN=$(curl -s -X POST \
          -H "Authorization: token $GITHUB_PAT" \
          -H "Accept: application/vnd.github.v3+json" \
          "https://api.github.com/repos/$REPO/actions/runners/registration-token" | jq -r .token)

        if [ "$REG_TOKEN" == "null" ] || [ -z "$REG_TOKEN" ]; then
          echo "[$(date)] Failed to get registration token, retrying in 30s..."
          sleep 30
          continue
        fi

        # Configure ephemeral runner
        echo "[$(date)] Configuring ephemeral runner $RUNNER_NAME"
        ./config.sh --url "$GITHUB_URL" --token "$REG_TOKEN" \
          --name "$RUNNER_NAME" \
          --labels "self-hosted,Linux,${RUNNER_ARCH},pool-runner" \
          --ephemeral \
          --unattended \
          --replace

        # Run the runner (blocks until job completes or interrupted)
        echo "[$(date)] Starting runner $RUNNER_NAME (waiting for job)"
        ./run.sh || true

        echo "[$(date)] Runner exited, cleaning up"

        # Small delay before next iteration
        sleep 5
      done

  - path: /opt/setup-runner.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      source /opt/runner-config.env

      # Detect architecture
      MACHINE_ARCH=$(uname -m)
      if [ "$MACHINE_ARCH" = "aarch64" ] || [ "$MACHINE_ARCH" = "arm64" ]; then
        RUNNER_ARCH="arm64"
      else
        RUNNER_ARCH="x64"
      fi

      # Download Runner once
      cd /home/runner-user
      LATEST_VERSION=$(curl -s https://api.github.com/repos/actions/runner/releases/latest | jq -r .tag_name | sed 's/v//')
      curl -o runner.tar.gz -L "https://github.com/actions/runner/releases/download/v${LATEST_VERSION}/actions-runner-linux-${RUNNER_ARCH}-${LATEST_VERSION}.tar.gz"

      # Set up runner directories and start launchers
      for i in $(seq 1 $NUM_RUNNERS); do
        RUNNER_DIR="/home/runner-user/actions-runner-${i}"

        echo ">>> Setting up runner directory $i"

        mkdir -p "$RUNNER_DIR"
        tar xzf /home/runner-user/runner.tar.gz -C "$RUNNER_DIR"
        chown -R runner-user:runner-user "$RUNNER_DIR"
      done

      # Cleanup download
      rm -f /home/runner-user/runner.tar.gz

      # Start launcher services
      for i in $(seq 1 $NUM_RUNNERS); do
        echo ">>> Starting launcher service for runner $i"

        # Create systemd service for each launcher
        cat > /etc/systemd/system/runner-launcher-${i}.service << EOF
      [Unit]
      Description=GitHub Actions Runner Launcher ${i}
      After=network.target

      [Service]
      Type=simple
      User=runner-user
      WorkingDirectory=/home/runner-user/actions-runner-${i}
      ExecStart=/opt/runner-launcher.sh ${i}
      Restart=always
      RestartSec=10

      [Install]
      WantedBy=multi-user.target
      EOF

        systemctl daemon-reload
        systemctl enable runner-launcher-${i}
        systemctl start runner-launcher-${i}
      done

      echo ">>> All runner launchers started"

runcmd:
  - /opt/setup-runner.sh
