#cloud-config
package_update: true

# Create a non-root user for the runner (GitHub runners cannot run as root)
users:
  - name: runner-user
    groups: docker
    shell: /bin/bash

write_files:
  - path: /opt/setup-runner.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      # 1. Variables passed from the creating script (via sed)
      GITHUB_URL="https://github.com/${GITHUB_REPOSITORY}"
      TOKEN="${RUNNER_TOKEN}"
      BASE_NAME="${RUNNER_NAME}"
      NUM_RUNNERS=2

      # 2. Detect architecture and set runner binary name
      MACHINE_ARCH=$(uname -m)
      if [ "$MACHINE_ARCH" = "aarch64" ] || [ "$MACHINE_ARCH" = "arm64" ]; then
        RUNNER_ARCH="arm64"
      else
        RUNNER_ARCH="x64"
      fi

      # 3. Download Runner once
      cd /home/runner-user
      LATEST_VERSION=$(curl -s https://api.github.com/repos/actions/runner/releases/latest | jq -r .tag_name | sed 's/v//')
      curl -o runner.tar.gz -L "https://github.com/actions/runner/releases/download/v${LATEST_VERSION}/actions-runner-linux-${RUNNER_ARCH}-${LATEST_VERSION}.tar.gz"

      # 4. Set up multiple runners
      for i in $(seq 1 $NUM_RUNNERS); do
        RUNNER_NAME="${BASE_NAME}-${i}"
        RUNNER_DIR="/home/runner-user/actions-runner-${i}"

        echo ">>> Setting up runner $i: $RUNNER_NAME"

        mkdir -p "$RUNNER_DIR"
        tar xzf /home/runner-user/runner.tar.gz -C "$RUNNER_DIR"

        chown -R runner-user:runner-user "$RUNNER_DIR"

        cd "$RUNNER_DIR"
        sudo -u runner-user ./config.sh --url "$GITHUB_URL" --token "$TOKEN" \
          --name "$RUNNER_NAME" \
          --labels "self-hosted,Linux,${RUNNER_ARCH},${BASE_NAME}" \
          --unattended

        ./svc.sh install runner-user
        ./svc.sh start

        echo ">>> Runner $RUNNER_NAME started"
      done

      # Cleanup
      rm -f /home/runner-user/runner.tar.gz

runcmd:
  - /opt/setup-runner.sh