#cloud-config
package_update: true

# Create a non-root user for the runner (GitHub runners cannot run as root)
users:
  - name: runner-user
    groups: docker
    shell: /bin/bash

write_files:
  - path: /opt/setup-runner.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      set -e

      # 1. Variables passed from the creating script (via sed)
      GITHUB_URL="https://github.com/${GITHUB_REPOSITORY}"
      TOKEN="${RUNNER_TOKEN}"
      NAME="${RUNNER_NAME}"

      # 2. Detect architecture and set runner binary name
      MACHINE_ARCH=$(uname -m)
      if [ "$MACHINE_ARCH" = "aarch64" ] || [ "$MACHINE_ARCH" = "arm64" ]; then
        RUNNER_ARCH="arm64"
      else
        RUNNER_ARCH="x64"
      fi

      # 3. Download Runner (Latest version logic)
      cd /home/runner-user
      mkdir actions-runner && cd actions-runner
      LATEST_VERSION=$(curl -s https://api.github.com/repos/actions/runner/releases/latest | jq -r .tag_name | sed 's/v//')
      curl -o runner.tar.gz -L "https://github.com/actions/runner/releases/download/v${LATEST_VERSION}/actions-runner-linux-${RUNNER_ARCH}-${LATEST_VERSION}.tar.gz"
      tar xzf runner.tar.gz

      # 4. Configure Runner (non-ephemeral to handle multiple jobs)
      chown -R runner-user:runner-user /home/runner-user/actions-runner
      sudo -u runner-user ./config.sh --url "$GITHUB_URL" --token "$TOKEN" --name "$NAME" --labels "self-hosted,Linux,${RUNNER_ARCH},${NAME}" --unattended

      # 5. Install as service and start
      ./svc.sh install runner-user
      ./svc.sh start

runcmd:
  - /opt/setup-runner.sh