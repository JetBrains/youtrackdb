name: Java CI/CD Integration Tests Pipeline
on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'
permissions:
  contents: write
  packages: write
  actions: write
  checks: write
jobs:
  check-changes:
    name: Check for Code Changes
    runs-on: ubuntu-latest
    # Define outputs so the next job can read them
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          ref: 'develop'
          # We only need the tip (depth 1) to get the current SHA. Very fast.
          fetch-depth: 1
      - name: Check against last successful run
        id: check
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # 1. If this is a manual trigger, always run.
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "Manual trigger detected. Force run."
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          # 2. Get the current commit SHA (on develop)
          CURRENT_SHA=$(git rev-parse HEAD)

          # 3. Get the SHA of the LAST SUCCESSFUL run of THIS specific workflow on 'develop'
          # We use the GitHub CLI (gh) to look up workflow history
          LAST_SUCCESS_SHA=$(gh run list --branch develop \
            --workflow "Java CI/CD Integration Tests Pipeline" \
            --status success \
            --limit 1 \
            --json headSha \
            -q '.[0].headSha')

          echo "Current SHA: $CURRENT_SHA"
          echo "Last Success SHA: $LAST_SUCCESS_SHA"

          # 4. Compare
          if [ "$CURRENT_SHA" == "$LAST_SUCCESS_SHA" ]; then
            echo "The current commit has already been successfully tested."
            echo "Skipping tests to save resources."
            echo "should_run=false" >> $GITHUB_OUTPUT
          else
            echo "New code detected (or no previous success found). Proceeding."
            echo "should_run=true" >> $GITHUB_OUTPUT
          fi

  start-runners:
    name: Start Hetzner Runner (${{ matrix.arch }})
    needs: check-changes
    if: needs.check-changes.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86, arm]
    env:
      HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6

      - name: Install hcloud CLI
        run: |
          curl -fsSL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar -xz
          sudo mv hcloud /usr/local/bin/hcloud

      - name: Start Self-Hosted Runner
        run: |
          bash .github/workflows/scripts/manage-runner.sh start ${{ matrix.arch }} "$HCLOUD_TOKEN" "${{ secrets.RUNNER_TOKEN }}" "${{ github.repository }}"

      - name: Wait for Runners to Register
        env:
          GH_TOKEN: ${{ secrets.RUNNER_TOKEN }}
        run: |
          BASE_NAME="runner-${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.arch }}"
          NUM_RUNNERS=2
          echo "Waiting for $NUM_RUNNERS runners with base name '$BASE_NAME' to come online..."

          for i in {1..60}; do
            ONLINE_COUNT=$(gh api repos/${{ github.repository }}/actions/runners \
              --jq "[.runners[] | select(.name | startswith(\"$BASE_NAME\")) | select(.status==\"online\")] | length" 2>/dev/null || echo "0")

            echo "Attempt $i/60: $ONLINE_COUNT/$NUM_RUNNERS runners online..."

            if [ "$ONLINE_COUNT" -ge "$NUM_RUNNERS" ]; then
              echo "All $NUM_RUNNERS runners are online!"
              exit 0
            fi
            sleep 10
          done

          echo "ERROR: Not all runners came online within 10 minutes"
          exit 1

  test-linux:
    name: Linux ${{ matrix.arch }} - JDK ${{ matrix.java }} - ${{ matrix.distribution }}
    needs: [check-changes, start-runners]
    if: needs.check-changes.outputs.should_run == 'true'
    runs-on: runner-${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.arch }}
    strategy:
      fail-fast: false
      matrix:
        java: [ '21', '25' ]
        distribution: [ 'temurin', 'corretto', 'oracle', 'zulu' ]  # microsoft removed for Linux (4 runners)
        arch: [ 'x86', 'arm' ]
        include:
          - arch: x86
            mvn_opts: '-Dmaven.test.failure.ignore=true -Dyoutrackdb.test.env=ci -P ci-integration-tests -P docker-images'
            java_arch: x64
          - arch: arm
            mvn_opts: '-Dmaven.test.failure.ignore=true -Dyoutrackdb.test.env=ci -P ci-integration-tests -P docker-images'
            java_arch: aarch64
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          ref: 'develop'
          fetch-depth: 0

      - name: Restore Maven cache from S3
        env:
          RCLONE_CONFIG_S3_TYPE: s3
          RCLONE_CONFIG_S3_PROVIDER: Other
          RCLONE_CONFIG_S3_ACCESS_KEY_ID: ${{ secrets.HETZNER_S3_ACCESS_KEY }}
          RCLONE_CONFIG_S3_SECRET_ACCESS_KEY: ${{ secrets.HETZNER_S3_SECRET_KEY }}
          RCLONE_CONFIG_S3_ENDPOINT: ${{ secrets.HETZNER_S3_ENDPOINT }}
          RCLONE_CONFIG_S3_ACL: private
        run: |
          mkdir -p ~/.m2/repository
          echo "Restoring Maven cache from S3..."
          rclone sync s3:maven-cache/repository ~/.m2/repository --transfers=16 --checkers=16 -v || echo "Cache restore failed or empty, continuing..."
          echo "Cache size: $(du -sh ~/.m2/repository 2>/dev/null | cut -f1 || echo 'empty')"

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java }}
          distribution: ${{ matrix.distribution }}
          architecture: ${{ matrix.java_arch }}
          overwrite-settings: false

      - name: Run Maven Test
        id: tests
        run: mvn -s .github/workflows/settings.xml clean verify -B ${{ matrix.mvn_opts }}
        env:
          MAVEN_MIROR_USERNAME: ${{ secrets.MAVEN_MIROR_USERNAME }}
          MAVEN_MIROR_PASSWORD: ${{ secrets.MAVEN_MIROR_PASSWORD }}

      - name: Save Maven cache to S3
        if: always()
        env:
          RCLONE_CONFIG_S3_TYPE: s3
          RCLONE_CONFIG_S3_PROVIDER: Other
          RCLONE_CONFIG_S3_ACCESS_KEY_ID: ${{ secrets.HETZNER_S3_ACCESS_KEY }}
          RCLONE_CONFIG_S3_SECRET_ACCESS_KEY: ${{ secrets.HETZNER_S3_SECRET_KEY }}
          RCLONE_CONFIG_S3_ENDPOINT: ${{ secrets.HETZNER_S3_ENDPOINT }}
          RCLONE_CONFIG_S3_ACL: private
        run: |
          echo "Saving Maven cache to S3..."
          rclone sync ~/.m2/repository s3:maven-cache/repository --transfers=16 --checkers=16 -v || echo "Cache save failed, continuing..."
          echo "Cache saved."

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action@v2
        if: always()
        with:
          files: |
            **/target/surefire-reports/TEST-*.xml
            **/target/failsafe-reports/TEST-*.xml
          action_fail: true
          large_files: true
          comment_mode: off
          check_name: Integration Tests Results (Linux ${{ matrix.arch }}, JDK ${{ matrix.java }} - ${{ matrix.distribution }})

  test-windows:
    name: Windows x64 - JDK ${{ matrix.java }} - ${{ matrix.distribution }}
    needs: check-changes
    if: false # Temporarily disabled
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        java: [ '21', '25' ]
        distribution: [ 'temurin', 'corretto', 'oracle', 'zulu', 'microsoft' ]
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          ref: 'develop'
          fetch-depth: 0

      - name: Set up JDK ${{ matrix.java }}
        uses: actions/setup-java@v5
        with:
          java-version: ${{ matrix.java }}
          distribution: ${{ matrix.distribution }}
          architecture: x64
          cache: 'maven'
          overwrite-settings: false

      - name: Run Maven Test
        id: tests
        run: mvn -s .github/workflows/settings.xml clean package -B `-Dmaven.test.failure.ignore=true `-Dyoutrackdb.test.env=ci
        env:
          MAVEN_MIROR_USERNAME: ${{ secrets.MAVEN_MIROR_USERNAME }}
          MAVEN_MIROR_PASSWORD: ${{ secrets.MAVEN_MIROR_PASSWORD }}

      - name: Publish Test Results
        uses: EnricoMi/publish-unit-test-result-action/windows@v2
        if: always()
        with:
          files: |
            **/target/surefire-reports/TEST-*.xml
            **/target/failsafe-reports/TEST-*.xml
          action_fail: true
          large_files: true
          comment_mode: off
          check_name: Integration Tests Results (Windows x64, JDK ${{ matrix.java }} - ${{ matrix.distribution }})

  stop-runners:
    name: Stop Hetzner Runner (${{ matrix.arch }})
    needs: [start-runners, test-linux]
    if: always() && needs.start-runners.result != 'skipped'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        arch: [x86, arm]
    env:
      HCLOUD_TOKEN: ${{ secrets.HCLOUD_TOKEN }}
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6

      - name: Install hcloud CLI
        run: |
          curl -fsSL https://github.com/hetznercloud/cli/releases/latest/download/hcloud-linux-amd64.tar.gz | tar -xz
          sudo mv hcloud /usr/local/bin/hcloud

      - name: Remove Runners from GitHub
        continue-on-error: true
        env:
          GH_TOKEN: ${{ secrets.RUNNER_TOKEN }}
        run: |
          BASE_NAME="runner-${{ github.run_id }}-${{ github.run_attempt }}-${{ matrix.arch }}"
          echo "Removing all runners with base name '$BASE_NAME'..."

          RUNNER_IDS=$(gh api repos/${{ github.repository }}/actions/runners \
            --jq ".runners[] | select(.name | startswith(\"$BASE_NAME\")) | .id" 2>/dev/null || echo "")

          if [ -z "$RUNNER_IDS" ]; then
            echo "No runners found with base name '$BASE_NAME'"
          else
            for RUNNER_ID in $RUNNER_IDS; do
              echo "Removing runner ID: $RUNNER_ID..."
              gh api -X DELETE repos/${{ github.repository }}/actions/runners/$RUNNER_ID || true
            done
          fi

      - name: Stop Self-Hosted Runner
        run: |
          bash .github/workflows/scripts/manage-runner.sh stop ${{ matrix.arch }} "$HCLOUD_TOKEN" "${{ secrets.RUNNER_TOKEN }}" "${{ github.repository }}"

  merge-to-main:
    name: Merge develop into main
    needs: [test-linux, stop-runners]  # test-windows temporarily disabled
    if: success() && github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6
        with:
          ref: 'main'
          fetch-depth: 0
          token: ${{ secrets.MAIN_UPDATE_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Verify branches are aligned for fast-forward
        run: |
          git fetch origin develop

          # Check if main is an ancestor of develop (required for fast-forward)
          if ! git merge-base --is-ancestor origin/main origin/develop; then
            echo "ERROR: main branch contains commits not present in develop."
            echo "Fast-forward merge is not possible. Branches have diverged."
            echo ""
            echo "Commits in main not in develop:"
            git log origin/develop..origin/main --oneline
            exit 1
          fi

          echo "Verification passed: main is an ancestor of develop, fast-forward is possible."

      - name: Merge develop into main (fast-forward only)
        run: |
          git merge origin/develop --ff-only
          git push origin main

  notify-failure:
    name: Notify build failure on Zulip
    needs: [ test-linux, merge-to-main ]  # test-windows temporarily disabled
    if: always() && github.event_name != 'workflow_dispatch' && (needs.test-linux.result == 'failure' || needs.merge-to-main.result == 'failure')
    runs-on: ubuntu-latest
    steps:
      - name: Send Zulip Notification
        uses: zulip/github-actions-zulip/send-message@v1
        with:
          api-key: ${{ secrets.ZULIP_API_KEY }}
          email: ci-status-bot@youtrackdb.zulipchat.com
          organization-url: 'https://youtrackdb.zulipchat.com'
          to: 'ytdb'
          type: 'stream'
          topic: 'ci status'
          content: |
            **BUILD FAILED** :rotating_light:
            Integration tests or merge failed on branch `${{ github.ref_name }}` for commit ${{ github.sha }} for repo ${{ github.repository }}.
            [View Run Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

  notify-fixed:
    name: Notify build fixed on Zulip
    needs: [ test-linux, merge-to-main ]  # test-windows temporarily disabled
    if: success() && github.event_name != 'workflow_dispatch'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v6

      - name: Get Previous Run Status
        id: previous_run
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          previous_conclusion=$(gh run list \
            --repo "${{ github.repository }}" \
            --branch "${{ github.ref_name }}" \
            --workflow "${{ github.workflow }}" \
            --limit 2 \
            --json conclusion \
            --jq '.[1].conclusion')
          echo "previous_conclusion=$previous_conclusion" >> $GITHUB_OUTPUT

      - name: Send Zulip notification
        if: steps.previous_run.outputs.previous_conclusion == 'failure'
        uses: zulip/github-actions-zulip/send-message@v1
        with:
          api-key: ${{ secrets.ZULIP_API_KEY }}
          email: ci-status-bot@youtrackdb.zulipchat.com
          organization-url: 'https://youtrackdb.zulipchat.com'
          to: 'ytdb'
          type: 'stream'
          topic: 'ci status'
          content: |
            **BUILD FIXED** :white_check_mark:
            Build fixed on branch `${{ github.ref_name }}` for commit ${{ github.sha }} for repo ${{ github.repository }}.
            [View Run Logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
